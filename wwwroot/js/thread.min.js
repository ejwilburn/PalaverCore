const PAGE_TITLE="Palaver",HUB_ACTION_RETRY_DELAY=5e3,INITIAL_SIGNALR_CONNECTION_RETRY_DELAY=200,NOTIFICATION_SNIPPET_SIZE=100,NOTIFICATION_DURATION=5e3,IMAGE_LOADING_TRANSITION_DURATION=300,wowhead_tooltips={colorlinks:!0,iconizelinks:!0,renamelinks:!0};class Thread{constructor(n,t,i){this.$thread=null;this.$threadList=null;this.$threads=null;this.threadId=n;this.commentId=t;this.totalUnread=0;this.userId=i;this.allowBack=!1;this.editor=null;this.editorForm=null;this.editingParentId=null;this.editing=null;this.editingCommentId=null;this.editingOrigText=null;this.srConnection=null;this.initialSignalrConnectionDone=!1;this.isMobile=Util.isMobileDisplay();this.loadToFirstUnread=!1;$(document).ready(()=>this.initPage())}initPage(){this.$thread=$("#thread");this.$threadList=$("#threadList");this.$threads=$("#threads");$("#reconnectingModal").modal({backdrop:"static",keyboard:!1,show:!1});this.startSignalr();window.onpopstate=n=>{if(Util.isNumber(n.state.threadId))this.threadId=n.state.threadId;else return;Util.isNumber(n.state.commentId)&&(this.commentId=n.state.commentId);this.loadThread(this.threadId,this.commentId,!0)};this.$threadList.sidebar("setting","dimPage",!1).sidebar("setting","closable",!1);this.isMobile&&Util.isNumber(this.threadId)&&this.$threadList.sidebar("hide");$("#newthreadicon").on("click",()=>{this.newThread()});$(document).keydown(n=>this.pageKeyDown(n));this.updateTotalUnreadDisplay();this.prepImages();this.formatDateTimes();Util.isNumber(this.threadId)&&(this.selectThread(this.threadId),Util.isNumber(this.commentId)&&this.focusCommentId(this.commentId));this.$threads.visibility({once:!1,initialCheck:!0,continuous:!0,checkOnRefresh:!0,context:this.$threadList,observeChanges:!0,onBottomVisible:()=>{},onUpdate:()=>{this.$threads.height()-this.$threadList.scrollTop()<=this.$threadList.height()&&this.loadMoreThreads()}});this.requestNotificationPermission()}openEditor(n,t){this.cancelReply();$(n).append(TemplateRenderer.render("editor"));this.editorForm=$("#editorForm");this.editor=CKEDITOR.replace("editor");this.editor.on("key",n=>this.replyKeyPressed(n));return t&&this.editor.setData(t),this.editor}cancelReply(){let n=this.editing,t=this.editingOrigText;this.closeEditor();n&&n.html(t)}closeEditor(){this.editor&&(this.editor.focusManager.blur(!0),this.editor.destroy(),this.editor=null,this.editing=null,this.editingParentId=null,this.editingCommentId=null,this.editingOrigText=null,$(this.editorForm).remove(),this.editorForm=null)}showDisconnected(){$("#reconnectingModal").modal("show")}hideDisconnected(){$("#reconnectingModal").modal("hide")}startSignalr(){this.srConnection=$.connection.signalrHub;this.srConnection.client.addThread=n=>{this.addThread(n)};this.srConnection.client.showThread=n=>{this.showThread(n)};this.srConnection.client.addToThreadsList=n=>{this.addToThreadsList(n)};this.srConnection.client.addComment=n=>{this.addComment(n)};this.srConnection.client.updateComment=n=>{this.updateComment(n)};$.connection.hub.error(function(n){console&&(n?console.log(n):console.log("Unknown SignalR hub error."))});$.connection.hub.connectionSlow(()=>{console&&console.log("SignalR is currently experiencing difficulties with the connection.")});$.connection.hub.reconnecting(()=>{this.showDisconnected(),console&&console.log("SignalR connection lost, reconnecting.")});$.connection.hub.disconnected(()=>{this.showDisconnected(),console&&console.log("SignlR lost its connection, reconnecting in 5 seconds."),setTimeout(()=>{console&&console.log("SignalR delayed reconnection in progress."),this.startSignalrHub()},5e3)});$.connection.hub.reconnected(()=>{console&&console.log("SignalR reconnected."),this.hideDisconnected()});this.startSignalrHub()}startSignalrHub(){$.connection.hub.logging=!0;$.connection.hub.start().done(()=>{this.hideDisconnected(),this.initialSignalrConnectionDone=!0,console&&console.log("Connected, transport = "+$.connection.hub.transport.name),Util.isNumber(this.commentId)&&(this.markReadByCommentId(this.commentId),this.commentId=null)})}formatDateTimes(n){let t=null;t=n?n:$("time.timeago");t.timeago()}prepImages(n){this.enableLazyImageLoading(n);Gifffer()}enableLazyImageLoading(n){let t=null;t=n?$(n.find(".text img.lazy")):$(".comment>.content>.text img.lazy");t.visibility({context:"#thread",type:"image",transition:"fade in",duration:IMAGE_LOADING_TRANSITION_DURATION})}loadMoreThreads(){if($("#threadsLoader").addClass("active"),!this.initialSignalrConnectionDone){setTimeout(()=>{this.loadMoreThreads()},INITIAL_SIGNALR_CONNECTION_RETRY_DELAY);return}let n=this.$threads,t=n.children(".item").length;this.srConnection.server.getPagedThreadsList(t).fail(n=>{this.loadMoreThreadsFailed(n)})}addToThreadsList(n){$(n).each((n,t)=>{this.$threads.children(`.item[data-id="${t.Id}"]`).length===0&&this.$threads.append(TemplateRenderer.render("threadListItem",t))});$("#threadsLoader").removeClass("active")}loadMoreThreadsFailed(n){console&&(console.error(n),console.info(`Retrying in ${HUB_ACTION_RETRY_DELAY/1e3} seconds...`));setTimeout(()=>{this.loadMoreThreads()},HUB_ACTION_RETRY_DELAY)}addThread(n){let t=n.UserId===this.userId;t&&(n.UnreadCount=0);this.$threads.prepend(TemplateRenderer.render("threadListItem",n));t?this.loadOwnThread(n):(this.notifyNewThread(n),this.updateTotalUnreadDisplay())}addComment(n){let r=n.UserId===this.userId,i=null,t=null;r?n.IsUnread=!1:(n.IsUnread=!0,this.incrementThreadUnread(n.ThreadId));n.ThreadId===this.threadId&&(t=$(TemplateRenderer.render("comment",n)),i=Util.isNumber(n.ParentCommentId)?this.$thread.find(`.comment[data-id="${n.ParentCommentId}"]>.comments`):this.$thread.children(".comments"),t.appendTo(i),i.removeClass("hidden"));this.popThread(n.ThreadId);r?(t.children(".edit").removeClass("hidden"),this.closeEditor(),this.focusCommentId(n.Id),this.clearBusy()):(this.updateTotalUnreadDisplay(),this.notifyNewComment(n));n.ThreadId===this.threadId&&(this.prepImages(t),this.formatDateTimes(t),twttr.widgets.load(t.get()))}updateComment(n){let i=n.UserId===this.userId;i&&(this.closeEditor(),this.focusCommentId(n.Id),this.clearBusy());let r=this.$thread.find(`.comment[data-id="${n.Id}"]`),t=r.find(".content>.text");t.html(n.DisplayText);this.prepImages(t);twttr.widgets.load(t.get())}popThread(n){let i=this.$threads.find(`[data-id="${n}"]`);i.prependTo(this.$threads);var r=new Date;let t=$(i).find("time.timeago");t.attr("title",null);t.attr("datetime",r.toISOString());t.timeago()}requestNotificationPermission(){this.isNotificationAllowed()&&Notification.permission==="default"&&Notification.requestPermission()}isNotificationAllowed(){return!Notification||Notification.permission==="denied"?!1:!0}notifyNewThread(n){if(this.isNotificationAllowed()){let i=`Palaver thread posted by ${n.UserName}.`,r={Title:$.trim(this.stripHtml(n.Title).substring(0,NOTIFICATION_SNIPPET_SIZE))},t=new Notification(i,{icon:BASE_URL+"images/new_message-icon.gif",body:TemplateRenderer.render("threadNotification",r)});t.onclick=t=>{t.preventDefault(),t.currentTarget.close(),window.focus(),this.loadThread(n.Id)};setTimeout(function(){t&&t.close()},NOTIFICATION_DURATION)}}notifyNewComment(n){if(this.isNotificationAllowed()){let i=`Palaver comment posted by ${n.UserName}.`,r=$.trim(this.stripHtml(n.Text).substring(0,NOTIFICATION_SNIPPET_SIZE)),t=new Notification(i,{icon:BASE_URL+"images/new_message-icon.gif",body:TemplateRenderer.render("commentNotification",r)});t.onclick=t=>{t.preventDefault(),t.currentTarget.close(),window.focus(),this.loadThread(n.ThreadId,n.Id)};setTimeout(function(){t&&t.close()},NOTIFICATION_DURATION)}}stripHtml(n){if(!Util.isString(n)||Util.isNullOrEmpty(n))return"";let t=document.createElement("DIV");return t.innerHTML=n,t.textContent||t.innerText}countAllUnread(){this.totalUnread=0;let n=this.$threads.find(".unread .unreadcount");if(n.length>0)for(let t=0;t<n.length;t++){let i=$(n[t]).text();Util.isNullOrEmpty(i)||(this.totalUnread+=parseInt(i))}}updateTotalUnreadDisplay(){if(this.countAllUnread(),document.title=this.totalUnread>0?`*${this.totalUnread}* ${PAGE_TITLE}`:PAGE_TITLE,this.isMobile){let n=$("#mobileUnread");n.text(this.totalUnread+" Unread");this.totalUnread>0?(n.removeClass("secondary"),n.addClass("primary")):(n.removeClass("primary"),n.addClass("secondary"))}}markReadByCommentId(n){this.markRead(this.$thread.find(`.comment[data-id="${n}"]`))}markRead(n){if($(n).hasClass("unread")){$(n).removeClass("unread");let i=$(n).data("id"),t=this.threadId;this.showBusy();this.srConnection.server.markRead(t,i).done(()=>{this.updateCurrentThreadUnread(t),this.clearBusy()}).fail(n=>{console&&(console.error(`Error marking comment ${id} as read.`),console.error(n)),this.clearBusy()})}this.updateTotalUnreadDisplay()}updateCurrentThreadUnread(n){let r=this.$thread.find(".unread").length,i=this.$threads.find(`[data-id="${n}"]`),t=i.find(".unreadcount");r>0?(t.html(r.toString()),t.removeClass("hidden"),i.addClass("unread")):(t.html("0"),t.addClass("hidden"),i.removeClass("unread"));this.updateTotalUnreadDisplay()}incrementThreadUnread(n){this.totalUnread++;let r=this.$threads.find(`[data-id="${n}"]`),t=r.find(".unreadcount"),i=t.html();if(Util.isNullOrEmpty(i)||i==="0")t.html("1");else{let n=parseInt(i)+1;t.html(n.toString())}r.addClass("unread");t.removeClass("hidden");this.updateTotalUnreadDisplay()}loadOwnThread(n){this.threadId=n.Id;this.allowBack=!1;history.pushState({threadId:n.Id},document.title,`${BASE_URL}Thread/${n.Id}`);this.allowBack=!0;this.closeEditor();this.$thread.replaceWith(TemplateRenderer.render("thread",n));this.$thread=$("#thread");this.selectThread(n.Id);this.$thread.scrollTop(0);this.formatDateTimes();this.openEditor(this.$thread.children(".comments"))}loadThread(n,t=null,i=false){this.threadId=n;this.commentId=t;let r=Util.isNumber(t);$("#threadLoader").addClass("active");i||(this.allowBack=!1,r?history.pushState({threadId:n,commentId:t},document.title,`${BASE_URL}Thread/${n}/${t}`):history.pushState({threadId:n},document.title,`${BASE_URL}Thread/${n}`),this.allowBack=!0);this.srConnection.server.loadThread(n).fail((n,t,i)=>{this.loadThreadFailed(n,t,i),this.clearBusy()})}showThread(n){let i=Util.isNumber(this.commentId);this.$threads.visibility("disable callbacks");let t=$(n);this.prepImages(t);this.formatDateTimes(t);twttr.widgets.load(t);this.closeEditor();this.$thread.replaceWith(t);this.$thread=$("#thread");i&&(this.focusAndMarkReadCommentId(this.commentId),this.commentId=null);this.selectThread(this.threadId);this.updateTotalUnreadDisplay();i||this.$thread.scrollTop(0);$("#threadLoader").removeClass("active");this.loadToFirstUnread&&(this.loadToFirstUnread=!1,this.goToNextUnread());this.$threads.visibility("enable callbacks")}loadThreadFailed(n,t,i){console&&(console.error(n),console.info(`Retrying in ${HUB_ACTION_RETRY_DELAY/1e3} seconds...`));setTimeout(()=>{this.loadThread(t,i)},HUB_ACTION_RETRY_DELAY)}selectThread(n){this.$threads.find(".active").removeClass("active");this.$threads.find(`[data-id="${n}"]`).addClass("active");this.isMobile&&this.$threadList.sidebar("hide")}replyTo(n){if(!Util.isNumber(n)){this.openEditor(this.$thread.children(".comments"));return}this.editingParentId=n;this.openEditor(this.$thread.find(`.comment[data-id="${n}"]>.comments`))}editComment(n){this.editingCommentId=n;this.editing=this.$thread.find(`.comment[data-id="${n}"]>.content>.text`);this.editingOrigText=this.editing.html();this.editing.empty();this.openEditor(this.editing,this.editingOrigText)}replyKeyPressed(n){return n.data.keyCode==2228237?(this.sendReply(),!1):n.data.keyCode==27?(this.cancelReply(),!1):!0}sendReply(){let t=this.editor.getData();if(Util.isNullOrEmpty(t)){alert("Replies cannot be empty.");return}let i=this.editingParentId;this.showBusy();let n=document.createElement("DIV");n.innerHTML=t;let r=$(n).find("a").each(function(){$(this).attr("target")||$(this).attr("target","_blank")});this.editing?this.saveUpdatedComment({Id:this.editingCommentId,Text:n.innerHTML}):this.newComment({Text:n.innerHTML,ThreadId:this.threadId,ParentCommentId:Util.isNumber(i)?i:null})}newComment(n){this.showBusy();Util.isNumber(n.ParentCommentId)||(n.ParentCommentId=null);this.srConnection.server.newComment(n.Text,n.ThreadId,n.ParentCommentId).fail(t=>{this.newCommentFailed(t,n),this.clearBusy()})}newCommentFailed(n,t){console&&(console.error(n),console.info(`Retrying in ${HUB_ACTION_RETRY_DELAY/1e3} seconds...`));setTimeout(()=>{this.newComment(t)},HUB_ACTION_RETRY_DELAY)}saveUpdatedComment(n){this.showBusy();this.srConnection.server.editComment(n.Id,n.Text).fail(t=>{this.saveUpdatedCommentError(t,n),this.clearBusy()})}saveUpdatedCommentError(n,t){console&&(console.error(n),console.info(`Retrying in ${HUB_ACTION_RETRY_DELAY/1e3} seconds...`));setTimeout(()=>{this.saveUpdatedComment(t)},HUB_ACTION_RETRY_DELAY)}newThread(){let n=$("#newthread").val();(!Util.isString(n)||Util.isNullOrEmpty(n))&&alert("Unable to determine thread title.");this.showBusy();this.srConnection.server.newThread(n).done(()=>{$("#newthread").val(""),this.clearBusy()}).fail(t=>{this.newThreadFailed(t,n),this.clearBusy()})}showBusy(){$(document.body).css({cursor:"wait"})}clearBusy(){$(document.body).css({cursor:"default"})}newThreadFailed(n,t){console&&(console.error(n),console.info(`Retrying in ${HUB_ACTION_RETRY_DELAY/1e3} seconds...`));setTimeout(()=>{this.newThread(t)},HUB_ACTION_RETRY_DELAY)}isEditorInUse(){return this.editor||$("input:focus").length>0||$("textarea:focus").length>0?!0:!1}pageKeyDown(n){if(this.isEditorInUse()){if($("#newthread:focus").length>0){if(n.keyCode==13)return this.newThread(),!1;if(n.keyCode==27)return $("#newthread").val("").blur(),!1}}else{if(n.keyCode==32)return this.goToNextUnread(),!1;if(n.keyCode==82){let i=this.$thread.find(".comment:focus"),t;t=i.length>0?$(i[0]):this.$thread;let r=null;return r=n.shiftKey===!1?t.data("parentid"):t.data("id"),this.replyTo(r),!1}if(n.keyCode==39||n.keyCode==40||n.keyCode==78)return this.focusNext(),!1;if(n.keyCode==37||n.keyCode==38||n.keyCode==80)return this.focusPrev(),!1}return!0}goToNextUnread(){let n=this.$thread.find(".unread");if(!n||n.length===0){this.isMobile&&this.loadNextUnreadThread();return}if(n.length==1){this.focusAndMarkRead($(n[0]));return}let t=this.$thread.find(".comment:focus"),i;if(t&&t.length!==0)i=$(t[0]).data("id");else{this.focusAndMarkRead($(n[0]));return}let r=this.findNextUnreadComment(i);Util.isNull(r)?this.focusAndMarkRead($(n[0])):this.focusAndMarkRead(r)}loadNextUnreadThread(){let n=this.$threads.children(".unread");n&&n.length!==0&&(this.loadToFirstUnread=!0,this.loadThread(n.data("id"),null,!1))}focusAndMarkRead(n){this.focusComment(n);this.markRead(n)}focusCommentId(n){this.focusComment(this.$thread.find(`.comment[data-id="${n}"]`))}focusAndMarkReadCommentId(n){this.focusAndMarkRead(this.$thread.find(`.comment[data-id="${n}"]`))}focusComment(n){this.$thread.scrollTop(this.$thread.scrollTop()+($(n).position().top-this.$thread.offset().top));$(n).focus()}focusNext(){let n=this.$thread.find(".comment:focus");if(n.length===0){this.focusComment(this.$thread.find(".comment").first());return}let t=this.findNextComment($(n[0]).data("id"));Util.isNull(t)||this.focusComment(t)}findNextComment(n){let t=this.$thread.find(".comment");if(t.length===0)return null;for(let i=0;i<t.length;i++)if($(t[i]).data("id")==n)return i+1<t.length?$(t[i+1]):null;return null}findNextUnreadComment(n){let t=this.$thread.find(".comment");if(t.length===0)return null;for(let i=0;i<t.length;i++)if($(t[i]).data("id")==n){for(let n=i+1;n<t.length;n++)if($(t[n]).hasClass("unread"))return $(t[n]);return null}return null}focusPrev(){let n=this.$thread.find(".comment");if(n.length!==0){if(n.length==1){this.focusComment($(n)[0]);return}let t=this.$thread.find(".comment:focus");if(t.length===0){this.focusComment(n.last());return}let i=$(t[0]).data("id");for(let t=n.length-1;t>-1;t--)if($(n[t]).data("id")==i){t-1>-1&&this.focusComment($(n[t-1]));return}}}}var templates={};class TemplateRenderer{static staticConstructor(){TemplateRenderer.loadTemplates()}static render(n,t=null){return Mustache.render(templates[n],t)}static loadTemplates(){$('script[data-istemplate="true"]').each((n,t)=>{let i=t.attributes.name.value;$.get(t.src,n=>{templates[i]=n})})}}TemplateRenderer.staticConstructor();
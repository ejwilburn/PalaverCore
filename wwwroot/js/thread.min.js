const PAGE_TITLE="Palaver",HUB_ACTION_RETRY_DELAY=5e3,NOTIFICATION_SNIPPET_SIZE=100,NOTIFICATION_DURATION=5e3,ASYNC_SCRIPTS=[{url:"//wow.zamimg.com/widgets/power.js",callback:null}],wowhead_tooltips={colorlinks:!0,iconizelinks:!0,renamelinks:!0};class Thread{constructor(n,t,i){this.threadId=n;this.commentId=t;this.userId=i;this.allowBack=!1;this.editor=null;this.editorForm=null;this.srConnection=null;this.templates={};this.editingParentId=null;this.editing=null;this.editingCommentId=null;this.editingOrigText=null;$(document).ready(()=>this.initPage())}initPage(){window.onpopstate=n=>{if(Object.isNumber(n.state.threadId))this.threadId=n.state.threadId;else return;Object.isNumber(n.state.commentId)&&(this.commentId=n.state.commentId);this.loadThread(this.threadId,this.commentId,!0)};$("#newthreadicon").on("click",()=>{this.newThread()});($(document).keydown(n=>this.pageKeyDown(n)),$("#reconnectingModal").modal({backdrop:"static",keyboard:!1,show:!1}),this.loadTemplates(),this.startSignalr(),this.updateTitle(),Object.isNumber(this.threadId))&&(this.selectThread(this.threadId),Object.isNumber(this.commentId)&&this.focusCommentId(this.commentId),this.fixEditing(),this.loadScriptsAsync())}loadScriptsAsync(){for(var n of ASYNC_SCRIPTS)this.loadScriptAsync(n.url,n.callback)}loadScriptAsync(n,t){t?$.getScript(n,(n,i,r)=>t(n,i,r)):$.getScript(n)}openEditor(n,t){this.cancelReply();$(n).append(Mustache.render(this.templates.editor));this.editorForm=$("#editorForm");this.editor=CKEDITOR.replace("editor");this.editor.on("key",n=>this.replyKeyPressed(n));return t&&this.editor.setData(t),this.editor}cancelReply(){let n=this.editing,t=this.editingOrigText;this.closeEditor();n&&n.html(t)}closeEditor(){this.editor&&(this.editor.focusManager.blur(!0),this.editor.destroy(),this.editor=null,this.editing=null,this.editingParentId=null,this.editingCommentId=null,this.editingOrigText=null,$(this.editorForm).remove(),this.editorForm=null)}fixEditing(){$(`#thread .comment:not([data-authorid="${this.userId}"])>.content>.actions>.edit`).remove()}showDisconnected(){$("#reconnectingModal").modal("show")}hideDisconnected(){$("#reconnectingModal").modal("hide")}startSignalr(){this.srConnection=$.connection.signalrHub;this.srConnection.client.addThread=n=>{this.addThread(n)};this.srConnection.client.addComment=n=>{this.addComment(n)};this.srConnection.client.updateComment=n=>{this.updateComment(n)};$.connection.hub.error(function(n){console&&(n?console.log(n):console.log("Unknown SignalR hub error."))});$.connection.hub.connectionSlow(()=>{console&&console.log("SignalR is currently experiencing difficulties with the connection.")});$.connection.hub.reconnecting(()=>{this.showDisconnected(),console&&console.log("SignalR connection lost, reconnecting.")});$.connection.hub.disconnected(()=>{this.showDisconnected(),console&&console.log("SignlR lost its connection, reconnecting in 5 seconds."),setTimeout(()=>{console&&console.log("SignlR delayed reconnection in progress."),this.startSignalrHub()},5e3)});$.connection.hub.reconnected(()=>{console&&console.log("SignalR reconnected."),this.hideDisconnected()});this.startSignalrHub()}startSignalrHub(){$.connection.hub.logging=!0;$.connection.hub.start().done(()=>{this.hideDisconnected(),console&&console.log("Connected, transport = "+$.connection.hub.transport.name)})}loadTemplates(){$("script[type=x-mustache-template]").each((n,t)=>{let i=t.attributes.name.value;$.get(t.src,n=>{this.templates[i]=n})})}addThread(n){let t=n.UserId===this.userId;t&&(n.UnreadCount=0);$("#threads").prepend(Mustache.render(this.templates.threadListItem,n));t?this.loadOwnThread(n):(this.notifyNewThread(n),this.updateTitle())}addComment(n){let r=n.UserId===this.userId,i=null,t=null;r?n.IsUnread=!1:this.incrementThreadUnread(n.ThreadId);n.ThreadId===this.threadId&&(t=$(Mustache.render(this.templates.comment,n)),i=Object.isNumber(n.ParentCommentId)?$(`#thread .comment[data-id="${n.ParentCommentId}"]>.comments`):$("#thread>.comments"),t.appendTo(i),i.removeClass("hidden"));this.popThread(n.ThreadId);r?(t.children(".edit").removeClass("hidden"),this.closeEditor(),this.focusComment(t),this.clearBusy()):(this.updateTitle(),this.notifyNewComment(n))}updateComment(n){let t=n.UserId===this.userId;t&&(this.closeEditor(),this.focusCommentId(n.Id),this.clearBusy());$(`#thread .comment[data-id="${n.Id}"]>.content>.text`).html(n.Text)}popThread(n){let t=$(`#threads [data-id="${n}"]`);t.prependTo("#threads");$(t).children(".time").html(this.getCurrentTimeString())}getCurrentTimeString(){return(new Date).toLocaleTimeString().replace(/:\d\d /," ")}notifyNewThread(n){if(Notification&&Notification.permission==="granted"){let i=`Palaver thread posted by ${n.UserName}.`,r={Title:$.trim(stripHtml(n.Title).substring(0,NOTIFICATION_SNIPPET_SIZE))},t=new Notification(i,{icon:BASE_URL+"images/new_message-icon.gif",body:Mustache.render(this.templates.threadNotification,r)});t.onclick=function(){window.focus();window.location.href=`${BASE_URL}Thread/${n.Id}`;this.cancel()};setTimeout(function(){t&&t.close()},NOTIFICATION_DURATION)}}notifyNewComment(n){if(Notification&&Notification.permission==="granted"){let i=`Palaver comment posted by ${n.UserName}.`,r={Text:$.trim(stripHtml(n.Text).substring(0,NOTIFICATION_SNIPPET_SIZE))},t=new Notification(i,{icon:BASE_URL+"images/new_message-icon.gif",body:filteredMessage});t.onclick=()=>{window.focus(),this.loadThread(this.threadId,this.commentId),this.cancel()};setTimeout(function(){t&&t.close()},NOTIFICATION_DURATION)}}stripHtml(n){if(!Object.isString(n)||n.isBlank())return"";let t=document.createElement("DIV");return t.innerHTML=n,innerDiv.textContent||innerDiv.innerText}updateTitle(){let n=$("#threads .unread .unreadcount"),t=0;if(n.length>0)for(let i=0;i<n.length;i++){let r=$(n[i]).text();Object.isString(r)&&!r.isBlank()&&(t+=parseInt(r))}document.title=t>0?`*${t}* ${PAGE_TITLE}`:PAGE_TITLE}markRead(n){if($(n).hasClass("unread")){$(n).removeClass("unread");let t=$(n).data("id");this.showBusy();this.srConnection.server.markRead(t).done(()=>{this.updateThreadUnread(this.threadId),this.clearBusy()}).fail(n=>{console&&(console.error(`Error marking comment ${t} as read.`),console.error(n)),this.clearBusy()})}this.updateTitle()}updateThreadUnread(n){let r=$("#thread .unread").length,i=$(`#threads [data-id="${n}"]`),t=i.find(".unreadcount");r>0?(t.html(r.toString()),t.removeClass("hidden"),i.addClass("unread")):(t.html("0"),t.addClass("hidden"),i.removeClass("unread"));this.updateTitle()}incrementThreadUnread(n){let r=$(`#threads [data-id="${n}"]`),t=r.find(".unreadcount"),i=t.html();if(i===null||i.length===0||i==="0")t.html("1");else{let n=parseInt(i)+1;t.html(n.toString())}r.addClass("unread");t.removeClass("hidden");this.updateTitle()}loadOwnThread(n){this.threadId=n.Id;this.allowBack=!1;history.pushState({threadId:n.Id},document.title,`${BASE_URL}Thread/${n.Id}`);this.allowBack=!0;this.closeEditor();$("#thread").replaceWith(Mustache.render(this.templates.thread,n));this.selectThread(n.Id);$("body").scrollTop(0);this.openEditor("#thread .comments")}loadThread(n,t=null,i=false){this.threadId=n;this.commentId=t;let r=Object.isNumber(t);i||(this.allowBack=!1,r?history.pushState({threadId:n,commentId:t},document.title,`${BASE_URL}Thread/${n}/${t}`):history.pushState({threadId:n},document.title,`${BASE_URL}Thread/${n}`),this.allowBack=!0);this.showBusy();$("#thread").html("");$.get(`${BASE_URL}api/RenderThread/${n}`,i=>{this.closeEditor(),$("#thread").replaceWith(i),r&&(this.focusAndMarkReadCommentId(t),this.commentId=null),this.selectThread(n),this.updateTitle(),this.fixEditing(),$("body").scrollTop(0),this.clearBusy()}).fail(n=>{this.clearBusy(),console&&(console.error("Error loading thread via AJAX."),console.error(n))})}selectThread(n){$("#threads .active").removeClass("active");$(`#threads [data-id="${n}"]`).addClass("active")}replyTo(n){if(!Object.isNumber(n)){this.openEditor($("#thread>.comments"));return}this.editingParentId=n;this.openEditor($(`.comment[data-id="${n}"]>.comments`))}editComment(n){this.editingCommentId=n;this.editing=$(`.comment[data-id="${n}"]>.content>.text`);this.editingOrigText=this.editing.html();this.editing.html("");this.openEditor(this.editing,this.editingOrigText)}replyKeyPressed(n){return n.data.keyCode==2228237?(this.sendReply(),!1):n.data.keyCode==27?(this.cancelReply(),!1):!0}sendReply(){let t=this.editor.getData();if(t.isBlank()){alert("Replies cannot be empty.");return}let i=this.editingParentId;this.showBusy();let n=document.createElement("DIV");n.innerHTML=t;let r=$(n).children("a").each(function(){$(this).attr("target")||$(this).attr("target","_blank")});this.editing?this.saveUpdatedComment({Id:this.editingCommentId,Text:n.innerHTML}):this.newComment({Text:n.innerHTML,ThreadId:this.threadId,ParentCommentId:Object.isNumber(i)?i:null})}newComment(n){this.showBusy();Object.isNumber(n.ParentCommentId)||(n.ParentCommentId=null);this.srConnection.server.newComment(n.Text,n.ThreadId,n.ParentCommentId).fail(t=>{this.newCommentFailed(t,n),this.clearBusy()})}newCommentFailed(n,t){console&&(console.error(n),console.info(`Retrying in ${HUB_ACTION_RETRY_DELAY/1e3} seconds...`));setTimeout(()=>{this.newComment(t)},HUB_ACTION_RETRY_DELAY)}saveUpdatedComment(n){this.showBusy();this.srConnection.server.editComment(n.Id,n.Text).fail(t=>{this.saveUpdatedCommentError(t,n),this.clearBusy()})}saveUpdatedCommentError(n,t){console&&(console.error(n),console.info(`Retrying in ${HUB_ACTION_RETRY_DELAY/1e3} seconds...`));setTimeout(()=>{this.saveUpdatedComment(t)},HUB_ACTION_RETRY_DELAY)}newThread(){let n=$("#newthread").val();(!Object.isString(n)||n.isBlank())&&alert("Unable to determine thread title.");this.showBusy();this.srConnection.server.newThread(n).done(()=>{$("#newthread").val(""),this.clearBusy()}).fail(t=>{this.newThreadFailed(t,n),this.clearBusy()})}showBusy(){$(document.body).css({cursor:"wait"})}clearBusy(){$(document.body).css({cursor:"default"})}newThreadFailed(n,t){console&&(console.error(n),console.info(`Retrying in ${HUB_ACTION_RETRY_DELAY/1e3} seconds...`));setTimeout(()=>{this.newThread(t)},HUB_ACTION_RETRY_DELAY)}isEditorInUse(){return $("input:focus").length>0||$(".jodit_editor:focus").length>0||$("textarea:focus").length>0?!0:!1}pageKeyDown(n){if(this.isEditorInUse()){if($("#newthread:focus").length>0){if(n.keyCode==13)return this.newThread(),!1;if(n.keyCode==27)return $("#newthread").val("").blur(),!1}}else{if(n.keyCode==32)return this.goToNextUnread(),!1;if(n.keyCode==82){let i=$("#thread .comment:focus"),t;t=i.length>0?$(i[0]):$("#thread");let r=null;return r=n.shiftKey===!1?t.data("parentid"):t.data("id"),this.replyTo(r),!1}if(n.keyCode==39||n.keyCode==40||n.keyCode==78)return this.focusNext(),!1;if(n.keyCode==37||n.keyCode==38||n.keyCode==80)return this.focusPrev(),!1}return!0}goToNextUnread(){let n=$("#thread .unread");if(n!==null&&n.length!==0){if(n.length==1){this.focusAndMarkRead($(n[0]));return}let t=$("#thread .comment:focus"),i;if(t===null||t.length===0){this.focusAndMarkRead($(n[0]));return}i=$(t[0]).data("id");let r=this.findNextUnreadComment(i);r===null?this.focusAndMarkRead($(n[0])):this.focusAndMarkRead(r)}}focusAndMarkRead(n){this.focusComment(n);this.markRead(n)}focusCommentId(n){this.focusComment($(`#thread .comment[data-id="${n}"]`))}focusAndMarkReadCommentId(n){this.focusAndMarkRead($(`#thread .comment[data-id="${n}"]`))}focusComment(n){let t=$("body");t.scrollTop(t.scrollTop()+($(n).position().top-t.offset().top));$(n).focus()}focusNext(){let n=$("#thread .comment:focus");if(n.length===0){this.focusComment($("#thread .comment").first());return}let t=this.findNextComment($(n[0]).data("id"));t!==null&&this.focusComment(t)}findNextComment(n){let t=$("#thread .comment");if(t.length===0)return null;for(let i=0;i<t.length;i++)if($(t[i]).data("id")==n)return i+1<t.length?$(t[i+1]):null;return null}findNextUnreadComment(n){let t=$("#thread .comment");if(t.length===0)return null;for(let i=0;i<t.length;i++)if($(t[i]).data("id")==n){for(let n=i+1;n<t.length;n++)if($(t[n]).hasClass("unread"))return $(t[n]);return null}return null}focusPrev(){let n=$("#thread .comment");if(n.length!==0){if(n.length==1){this.focusComment($(n)[0]);return}let t=$("#thread .comment:focus");if(t.length===0){this.focusComment(n.last());return}let i=$(t[0]).data("id");for(let t=n.length-1;t>-1;t--)if($(n[t]).data("id")==i){t-1>-1&&this.focusComment($(n[t-1]));return}}}}